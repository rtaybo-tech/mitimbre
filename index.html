import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  setDoc 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { Bell, Settings, X, Send, Trash2, AlertTriangle } from 'lucide-react';

// Configuraci贸n de Firebase proporcionada por el entorno
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'timbre-comercial-pro';

const App = () => {
  const [user, setUser] = useState(null);
  const [timbres, setTimbres] = useState([]);
  const [showLegal, setShowLegal] = useState(true);
  const [showAdmin, setShowAdmin] = useState(false);
  const [showAlert, setShowAlert] = useState(false);
  const [selectedTimbre, setSelectedTimbre] = useState(null);
  const [clickCount, setClickCount] = useState(0);
  const [lastClick, setLastClick] = useState(0);
  
  // Estados para nuevo timbre
  const [newName, setNewName] = useState('');
  const [newPhone, setNewPhone] = useState('');

  // Identificador del cliente desde la URL (?id=casa1)
  const urlParams = new URLSearchParams(window.location.search);
  const clienteID = urlParams.get('id') || 'general';

  // 1. Autenticaci贸n inicial
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Error de autenticaci贸n", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Escuchar datos de la Nube (Firestore)
  useEffect(() => {
    if (!user) return;

    // Referencia al documento espec铆fico de este cliente/edificio
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'clientes', clienteID);
    
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        setTimbres(docSnap.data().lista || []);
      } else {
        setTimbres([]);
      }
    }, (error) => {
      console.error("Error leyendo de la nube:", error);
    });

    return () => unsubscribe();
  }, [user, clienteID]);

  // Manejo de acceso administrativo (4 clics)
  const handleLogoClick = () => {
    const now = Date.now();
    if (now - lastClick > 1500) {
      setClickCount(1);
    } else {
      const newCount = clickCount + 1;
      setClickCount(newCount);
      if (newCount === 4) {
        setClickCount(0);
        const pass = prompt("Ingrese la clave de configuraci贸n (siso1926):");
        if (pass === "siso1926") {
          setShowAdmin(true);
        } else {
          alert("Clave incorrecta.");
        }
      }
    }
    setLastClick(now);
  };

  // Guardar en la Nube
  const saveToCloud = async (nuevaLista) => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'clientes', clienteID);
    try {
      await setDoc(docRef, { lista: nuevaLista, updatedAt: Date.now() });
    } catch (error) {
      alert("Error al guardar en la nube. Verifique su conexi贸n.");
    }
  };

  const addTimbre = () => {
    if (!newName || !newPhone) return alert("Complete los datos");
    // Formatear el n煤mero por si el usuario pone el "+"
    const cleanPhone = newPhone.replace(/\D/g, '');
    const nuevaLista = [...timbres, { id: Date.now(), nombre: newName, whatsapp: cleanPhone }];
    setTimbres(nuevaLista);
    saveToCloud(nuevaLista);
    setNewName('');
    setNewPhone('');
  };

  const removeTimbre = (id) => {
    if (confirm("驴Est谩 seguro de eliminar este bot贸n?")) {
      const nuevaLista = timbres.filter(t => t.id !== id);
      setTimbres(nuevaLista);
      saveToCloud(nuevaLista);
    }
  };

  const triggerWhatsApp = () => {
    const mensaje = encodeURIComponent(" *AVISO DE TIMBRE*: Hay alguien en la puerta solicitando atenci贸n.");
    window.location.href = `https://api.whatsapp.com/send?phone=${selectedTimbre.whatsapp}&text=${mensaje}`;
    setShowAlert(false);
  };

  if (showLegal) {
    return (
      <div className="fixed inset-0 bg-black/95 z-[5000] flex items-center justify-center p-6 text-white font-sans">
        <div className="bg-[#1e1e1e] p-8 rounded-3xl border border-gray-800 max-w-md w-full text-center shadow-2xl">
          <div className="flex justify-center mb-4 text-[#25d366]">
            <AlertTriangle size={48} />
          </div>
          <h2 className="text-2xl font-bold mb-4">Aviso Legal</h2>
          <p className="text-sm text-gray-400 text-justify mb-8 leading-relaxed">
            Este sistema es un facilitador de contacto t茅cnico entre visitantes y residentes. 
            El prestador del servicio no se responsabiliza por el contenido de los mensajes 
            enviados ni por el uso indebido de la plataforma. Al continuar, usted acepta que 
            el sistema redirigir谩 su solicitud a la aplicaci贸n WhatsApp del destinatario. 
            No se almacenan datos personales en servidores externos conforme a la Ley 25.326.
          </p>
          <button 
            onClick={() => setShowLegal(false)}
            className="w-full py-4 bg-[#25d366] text-black font-bold rounded-xl hover:bg-[#128c7e] transition-colors"
          >
            Acepto y deseo continuar
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#121212] text-white font-sans p-6 flex flex-col items-center">
      
      {/* HEADER */}
      <header className="text-center mb-10 w-full max-w-md">
        <div 
          onClick={handleLogoClick}
          className="text-6xl mb-4 cursor-pointer select-none active:scale-90 transition-transform inline-block"
        >
          
        </div>
        <h1 className="text-3xl font-bold mb-1">Timbre Digital</h1>
        {clienteID !== 'general' && (
          <p className="text-[#25d366] text-xs font-bold tracking-widest uppercase mb-2">
            ID de Propiedad: {clienteID}
          </p>
        )}
        <p className="text-gray-500 text-sm italic">Servicio de Enlace T茅cnico v3.1</p>
      </header>

      {/* GRID DE BOTONES */}
      <div className="grid grid-cols-2 gap-4 w-full max-w-md">
        {timbres.length === 0 ? (
          <div className="col-span-2 py-20 text-center text-gray-600 border-2 border-dashed border-gray-800 rounded-2xl">
            <p className="mb-2">Sin botones configurados</p>
            <p className="text-xs">Escanee y use el panel de control</p>
          </div>
        ) : (
          timbres.map((item) => (
            <button
              key={item.id}
              onClick={() => { setSelectedTimbre(item); setShowAlert(true); }}
              className="bg-[#1e1e1e] p-6 rounded-2xl border border-gray-800 flex flex-col items-center active:bg-[#2a2a2a] transition-colors shadow-lg h-full justify-center"
            >
              <span className="text-[10px] text-[#25d366] font-bold mb-1 uppercase">Tocar Timbre</span>
              <span className="text-lg font-bold text-center break-words w-full leading-tight">{item.nombre}</span>
            </button>
          ))
        )}
      </div>

      {/* PANEL ADMIN (CLOUD) */}
      {showAdmin && (
        <div className="fixed inset-0 bg-[#121212] z-[6000] p-6 overflow-y-auto">
          <div className="max-w-md mx-auto">
            <div className="flex justify-between items-center mb-8">
              <div>
                <h2 className="text-2xl font-bold">Panel de Control</h2>
                <p className="text-[#25d366] text-xs font-mono uppercase">ID: {clienteID}</p>
              </div>
              <button onClick={() => setShowAdmin(false)} className="p-2 bg-gray-800 rounded-full">
                <X size={24} />
              </button>
            </div>

            <div className="bg-[#1e1e1e] p-6 rounded-3xl border border-gray-800 mb-8 shadow-xl">
              <h3 className="font-bold mb-4 flex items-center gap-2">
                <Settings size={18} className="text-[#25d366]" /> A帽adir Nuevo Bot贸n
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="text-xs text-gray-500 block mb-1 uppercase font-bold">Etiqueta (Ej: Depto 102)</label>
                  <input 
                    type="text" 
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    className="w-full bg-[#2a2a2a] border border-gray-700 p-4 rounded-xl focus:outline-none focus:border-[#25d366] text-white"
                    placeholder="Nombre que ver谩 el visitante"
                  />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block mb-1 uppercase font-bold">WhatsApp (Sin +, ej: 54911...)</label>
                  <input 
                    type="number" 
                    value={newPhone}
                    onChange={(e) => setNewPhone(e.target.value)}
                    className="w-full bg-[#2a2a2a] border border-gray-700 p-4 rounded-xl focus:outline-none focus:border-[#25d366] text-white"
                    placeholder="54911XXXXXXXX"
                  />
                </div>
                <button 
                  onClick={addTimbre}
                  className="w-full py-4 bg-[#25d366] text-black font-extrabold rounded-xl shadow-lg active:scale-95 transition-transform"
                >
                  Sincronizar con la Nube
                </button>
              </div>
            </div>

            <h3 className="font-bold mb-4 px-2">Botones Configurados ({timbres.length})</h3>
            <div className="space-y-3 pb-20">
              {timbres.map((item) => (
                <div key={item.id} className="bg-[#1e1e1e] p-4 rounded-2xl border border-gray-800 flex justify-between items-center">
                  <div className="overflow-hidden">
                    <p className="font-bold truncate">{item.nombre}</p>
                    <p className="text-xs text-gray-500 font-mono">{item.whatsapp}</p>
                  </div>
                  <button 
                    onClick={() => removeTimbre(item.id)} 
                    className="text-red-500 p-3 bg-red-500/10 rounded-xl active:bg-red-500/20"
                  >
                    <Trash2 size={20} />
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* MODAL DE CONFIRMACIN WHATSAPP */}
      {showAlert && (
        <div className="fixed inset-0 bg-black/80 z-[7000] flex items-end sm:items-center justify-center p-4">
          <div className="bg-white text-black p-8 rounded-t-[40px] sm:rounded-[32px] max-w-md w-full text-center shadow-2xl">
            <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 className="text-2xl font-black mb-2">Anunciarse</h3>
            <p className="text-gray-600 mb-8 text-sm px-4">
              驴Desea enviar una notificaci贸n a <b>{selectedTimbre?.nombre}</b>?
            </p>
            <div className="flex gap-4">
              <button 
                onClick={() => setShowAlert(false)}
                className="flex-1 py-5 bg-gray-100 font-bold rounded-2xl hover:bg-gray-200 active:scale-95 transition-transform"
              >
                Cerrar
              </button>
              <button 
                onClick={triggerWhatsApp}
                className="flex-1 py-5 bg-[#25d366] text-white font-black rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-transform"
              >
                <Send size={20} /> ENVIAR
              </button>
            </div>
            <p className="mt-6 text-[9px] text-gray-400 uppercase tracking-widest font-bold">
              Enlace Seguro v铆a WhatsApp Business
            </p>
          </div>
        </div>
      )}

      <footer className="mt-auto py-8 opacity-20 text-[10px] tracking-[5px] font-bold">
        NUBE ACTIVA - ENLACE TCNICO
      </footer>
    </div>
  );
};

export default App;
